# è½¨è¿¹ç”Ÿæˆæ¨¡å—å¼€å‘ TODO List

## ğŸ“‹ é¡¹ç›®èƒŒæ™¯

### ä¸šåŠ¡éœ€æ±‚
åœ¨ç°æœ‰çš„bboxç©ºé—´åˆ†æåŸºç¡€ä¸Šï¼Œéœ€è¦æ›´ç²¾ç»†çš„è½¨è¿¹çº§åˆ†æèƒ½åŠ›ï¼š
1. **ç°çŠ¶**: bboxæ¨¡å—æä¾›åŒºåŸŸçº§åˆ†æï¼ˆpolygonï¼‰ï¼Œé€‚åˆå¤§èŒƒå›´ç©ºé—´ç­›é€‰
2. **éœ€æ±‚**: åœ¨bboxåˆ†æåï¼Œå¯¹ç‰¹å®šscene_idè¿›è¡Œè½¨è¿¹çº§ç²¾ç»†åˆ†æï¼ˆlinestring + eventsï¼‰
3. **å·¥ä½œæµ**: `bboxåˆ†æ â†’ QGISç­›é€‰ â†’ scene_idåˆ—è¡¨ â†’ è½¨è¿¹åˆ†æ`

### æŠ€æœ¯ç›®æ ‡
- ä»scene_idåˆ—è¡¨ç”Ÿæˆè¿ç»­è½¨è¿¹çº¿ï¼ˆLineStringï¼‰
- æ£€æµ‹è½¨è¿¹ä¸­çš„å…³é”®å˜åŒ–ç‚¹ï¼ˆAVPçŠ¶æ€ã€é€Ÿåº¦çªå˜ç­‰ï¼‰
- æ”¯æŒdatasetå±æ€§ç»§æ‰¿ï¼Œä¿æŒæ•°æ®ä¸€è‡´æ€§
- ç‹¬ç«‹æ¨¡å—è®¾è®¡ï¼Œä¸å½±å“ç°æœ‰bboxåŠŸèƒ½

### æ•°æ®æ¶æ„
```
è½¨è¿¹è¡¨: trajectories_[table_name] (LineString + ç»Ÿè®¡ä¿¡æ¯)
å˜åŒ–ç‚¹è¡¨: trajectory_events_[table_name] (Point + å˜åŒ–ä¿¡æ¯)
```

## ğŸš€ å¼€å‘é˜¶æ®µ

### Phase 1: åŸºç¡€è½¨è¿¹ç”Ÿæˆ [P0]
**ç›®æ ‡**: å®ç°ä»scene_idåˆ°è½¨è¿¹çº¿çš„åŸºç¡€åŠŸèƒ½
**ä¼°æ—¶**: 5-7å¤©

#### âœ… å®Œæˆé¡¹ç›®
- [ ] **ç¯å¢ƒæ­å»º**
  - [ ] åˆ›å»º `src/spdatalab/dataset/trajectory.py`
  - [ ] è®¾ç½®åŸºç¡€ä¾èµ–å¯¼å…¥
  - [ ] é…ç½®æ•°æ®åº“è¿æ¥å¸¸é‡

#### ğŸ”„ è¿›è¡Œä¸­é¡¹ç›®
- [ ] **æ•°æ®åŠ è½½æ¨¡å—**
  - [ ] å®ç° `load_scene_ids()` - ä»txtæ–‡ä»¶åŠ è½½scene_idåˆ—è¡¨
  - [ ] æ·»åŠ æ•°æ®éªŒè¯å’Œé”™è¯¯å¤„ç†
  - [ ] æ”¯æŒç©ºè¡Œå’Œæ³¨é‡Šè¿‡æ»¤

#### ğŸ“‹ å¾…åŠé¡¹ç›®
- [ ] **è½¨è¿¹ç‚¹æŸ¥è¯¢**
  - [ ] å®ç° `fetch_trajectory_points()` - æŸ¥è¯¢å•ä¸ªsceneçš„è½¨è¿¹ç‚¹
  - [ ] ç¼–å†™SQLæŸ¥è¯¢è¯­å¥ï¼ˆä»ddi_data_pointsè¡¨ï¼‰
  - [ ] æ‰¹é‡æŸ¥è¯¢ä¼˜åŒ–
  - [ ] ç‚¹æ•°æ®æ—¶é—´æ’åº

- [ ] **è½¨è¿¹å‡ ä½•æ„å»º**
  - [ ] å®ç° `build_trajectory()` - æ„å»ºLineStringå‡ ä½•
  - [ ] è½¨è¿¹é•¿åº¦è®¡ç®—ï¼ˆPostGIS ST_Lengthï¼‰
  - [ ] æ—¶é—´è·¨åº¦å’Œç‚¹æ•°é‡ç»Ÿè®¡
  - [ ] é€Ÿåº¦ç»Ÿè®¡è®¡ç®—ï¼ˆavg, max, min, stdï¼‰
  - [ ] AVPç‚¹ç»Ÿè®¡

- [ ] **æ•°æ®åº“è¡¨ç®¡ç†**
  - [ ] å®ç° `create_trajectory_table()` - åˆ›å»ºè½¨è¿¹è¡¨
  - [ ] è¡¨ç»“æ„SQL + PostGISå‡ ä½•åˆ—
  - [ ] ç´¢å¼•åˆ›å»ºï¼ˆgeometry, scene_tokenï¼‰
  - [ ] å®ç° `insert_trajectory_data()` - æ‰¹é‡æ•°æ®æ’å…¥

- [ ] **CLIåŸºç¡€æ¥å£**
  - [ ] åŸºç¡€å‘½ä»¤è¡Œå‚æ•°è§£æ
  - [ ] ç®€å•çš„è¿›åº¦æ˜¾ç¤º
  - [ ] é”™è¯¯æ—¥å¿—è®°å½•

### Phase 2: å˜åŒ–ç‚¹æ£€æµ‹ [P1]
**ç›®æ ‡**: è¯†åˆ«è½¨è¿¹ä¸­çš„å…³é”®å˜åŒ–ç‚¹
**ä¼°æ—¶**: 3-4å¤©

#### ğŸ“‹ å¾…åŠé¡¹ç›®
- [ ] **AVPå˜åŒ–æ£€æµ‹**
  - [ ] å®ç° `detect_avp_changes()` - AVPçŠ¶æ€å˜åŒ–æ£€æµ‹
  - [ ] çŠ¶æ€åˆ‡æ¢ç‚¹è¯†åˆ«ï¼ˆ0â†”1ï¼‰
  - [ ] å˜åŒ–ç‚¹ä½ç½®å’Œå±æ€§è®°å½•

- [ ] **é€Ÿåº¦çªå˜æ£€æµ‹**
  - [ ] å®ç° `detect_speed_spikes()` - åŸºäºç»Ÿè®¡çš„é€Ÿåº¦å¼‚å¸¸æ£€æµ‹
  - [ ] å¯é…ç½®é˜ˆå€¼å‚æ•°ï¼ˆæ ‡å‡†å·®å€æ•°ï¼‰
  - [ ] çªå˜å¹…åº¦è®¡ç®—

- [ ] **å˜åŒ–ç‚¹è¡¨ç®¡ç†**
  - [ ] å®ç° `create_events_table()` - åˆ›å»ºå˜åŒ–ç‚¹è¡¨
  - [ ] å¤–é”®çº¦æŸåˆ°è½¨è¿¹è¡¨
  - [ ] å®ç° `insert_events_data()` - å˜åŒ–ç‚¹æ•°æ®æ’å…¥

- [ ] **å…¶ä»–å˜åŒ–ç‚¹ç±»å‹**
  - [ ] workstageå˜åŒ–æ£€æµ‹ï¼ˆå¯é€‰ï¼‰
  - [ ] å¯æ‰©å±•çš„å˜åŒ–ç‚¹æ£€æµ‹æ¡†æ¶

### Phase 3: å¢å¼ºåŠŸèƒ½ [P2]
**ç›®æ ‡**: Datasetå±æ€§ç»§æ‰¿å’ŒCLIå®Œå–„
**ä¼°æ—¶**: 4-5å¤©

#### ğŸ“‹ å¾…åŠé¡¹ç›®
- [ ] **Datasetå±æ€§ç»§æ‰¿**
  - [ ] å®ç° `load_dataset_metadata()` - è§£ædatasetæ–‡ä»¶
  - [ ] æ”¯æŒJSON/Parquetæ ¼å¼
  - [ ] scene_tokenä¸datasetå±æ€§æ˜ å°„
  - [ ] åŠ¨æ€è¡¨å­—æ®µåˆ›å»º
  - [ ] å±æ€§æ•°æ®ç±»å‹è½¬æ¢

- [ ] **CLIæ¥å£å®Œå–„**
  - [ ] å®Œæ•´å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ
  - [ ] `--dataset` å‚æ•°æ”¯æŒ
  - [ ] `--inherit-attributes` é€‰é¡¹
  - [ ] `--detect-avp-changes` é€‰é¡¹
  - [ ] `--detect-speed-spikes` é€‰é¡¹
  - [ ] `--speed-spike-threshold` å‚æ•°

- [ ] **è¿›åº¦è·Ÿè¸ªå¢å¼º**
  - [ ] è¯¦ç»†è¿›åº¦æ˜¾ç¤º
  - [ ] é”™è¯¯ç»Ÿè®¡å’Œæ±‡æ€»
  - [ ] å¤„ç†æ—¥å¿—ä¼˜åŒ–

### Phase 4: æµ‹è¯•éªŒè¯ [P1]
**ç›®æ ‡**: ç¡®ä¿åŠŸèƒ½æ­£ç¡®æ€§å’Œæ€§èƒ½
**ä¼°æ—¶**: 2-3å¤©

#### ğŸ“‹ å¾…åŠé¡¹ç›®
- [ ] **åŠŸèƒ½æµ‹è¯•**
  - [ ] åŸºç¡€è½¨è¿¹ç”Ÿæˆæµ‹è¯•
  - [ ] å˜åŒ–ç‚¹æ£€æµ‹å‡†ç¡®æ€§æµ‹è¯•
  - [ ] ä¸åŒæ•°æ®è§„æ¨¡æµ‹è¯•
  - [ ] é”™è¯¯åœºæ™¯å¤„ç†æµ‹è¯•

- [ ] **æ€§èƒ½éªŒè¯**
  - [ ] 1000ä¸ªscene_idå¤„ç†æ€§èƒ½æµ‹è¯•
  - [ ] å†…å­˜ä½¿ç”¨ç›‘æ§
  - [ ] æ•°æ®åº“æ“ä½œæ€§èƒ½æµ‹è¯•

- [ ] **é›†æˆéªŒè¯**
  - [ ] ä¸ç°æœ‰ç³»ç»Ÿå…¼å®¹æ€§æµ‹è¯•
  - [ ] ç«¯åˆ°ç«¯å·¥ä½œæµéªŒè¯

## ğŸ¯ å½“å‰ä¼˜å…ˆçº§

### ç«‹å³å¼€å§‹
1. **ç¯å¢ƒæ­å»º** - åˆ›å»ºåŸºç¡€æ–‡ä»¶ç»“æ„
2. **æ•°æ®åŠ è½½** - scene_idåˆ—è¡¨åŠ è½½åŠŸèƒ½
3. **è½¨è¿¹ç‚¹æŸ¥è¯¢** - æ ¸å¿ƒæ•°æ®è·å–åŠŸèƒ½

### æœ¬å‘¨ç›®æ ‡
- [ ] å®ŒæˆPhase 1çš„æ ¸å¿ƒåŠŸèƒ½
- [ ] å®ç°åŸºç¡€çš„è½¨è¿¹ç”Ÿæˆpipeline
- [ ] åŸºç¡€CLIæ¥å£å¯ç”¨

### éªŒæ”¶æ ‡å‡†
- [ ] èƒ½å¤Ÿä»scene_idåˆ—è¡¨ç”Ÿæˆè½¨è¿¹è¡¨
- [ ] è½¨è¿¹å‡ ä½•æ­£ç¡®ï¼ˆLineStringæ ¼å¼ï¼‰
- [ ] ç»Ÿè®¡æŒ‡æ ‡è®¡ç®—å‡†ç¡®
- [ ] åŸºç¡€å˜åŒ–ç‚¹æ£€æµ‹åŠŸèƒ½
- [ ] CLIæ¥å£å‹å¥½æ˜“ç”¨

## ğŸ“ å¼€å‘è®°å½•

### 2025-01-XX - é¡¹ç›®å¯åŠ¨
- [x] åˆ›å»ºå¼€å‘TODOæ–‡æ¡£
- [x] å¼€å§‹ç¯å¢ƒæ­å»º

### 2025-01-XX - Phase 1å®Œæˆ
- [x] **ç¯å¢ƒæ­å»ºå®Œæˆ**
  - [x] åˆ›å»º `src/spdatalab/dataset/trajectory.py`
  - [x] è®¾ç½®åŸºç¡€ä¾èµ–å¯¼å…¥å’Œæ•°æ®åº“è¿æ¥
  - [x] é…ç½®æ—¥å¿—å’Œä¿¡å·å¤„ç†

- [x] **æ ¸å¿ƒåŠŸèƒ½å®ç°å®Œæˆ**
  - [x] å®ç° `load_scene_ids()` - ä»txtæ–‡ä»¶åŠ è½½scene_idåˆ—è¡¨
  - [x] å®ç° `fetch_trajectory_points()` - æŸ¥è¯¢è½¨è¿¹ç‚¹æ•°æ®
  - [x] å®ç° `build_trajectory()` - æ„å»ºLineStringå‡ ä½•å’Œç»Ÿè®¡ä¿¡æ¯
  - [x] å®ç° `create_trajectory_table()` - åˆ›å»ºè½¨è¿¹è¡¨
  - [x] å®ç° `insert_trajectory_data()` - æ‰¹é‡æ•°æ®æ’å…¥
  - [x] åŸºç¡€CLIæ¥å£å®Œæˆ

### 2025-01-XX - Phase 2å®Œæˆ
- [x] **å˜åŒ–ç‚¹æ£€æµ‹åŠŸèƒ½å®Œæˆ**
  - [x] å®ç° `detect_avp_changes()` - AVPçŠ¶æ€å˜åŒ–æ£€æµ‹
  - [x] å®ç° `detect_speed_spikes()` - é€Ÿåº¦çªå˜æ£€æµ‹
  - [x] å®ç° `create_events_table()` - åˆ›å»ºå˜åŒ–ç‚¹è¡¨
  - [x] å®ç° `insert_events_data()` - å˜åŒ–ç‚¹æ•°æ®æ’å…¥
  - [x] CLIå‚æ•°å®Œå–„ï¼ˆ--detect-avp, --detect-speed, --speed-thresholdï¼‰

### å½“å‰çŠ¶æ€
- âœ… **Phase 1: åŸºç¡€è½¨è¿¹ç”Ÿæˆ** - 100%å®Œæˆ
- âœ… **Phase 2: å˜åŒ–ç‚¹æ£€æµ‹** - 100%å®Œæˆ
- â³ **Phase 3: å¢å¼ºåŠŸèƒ½** - å¾…å¼€å‘
- â³ **Phase 4: æµ‹è¯•éªŒè¯** - å¾…å¼€å‘

### å·²å®ç°åŠŸèƒ½
1. **è½¨è¿¹ç”Ÿæˆ**ï¼šä»scene_idåˆ—è¡¨ç”Ÿæˆè¿ç»­è½¨è¿¹çº¿ï¼ˆLineStringï¼‰
2. **ç»Ÿè®¡è®¡ç®—**ï¼šè½¨è¿¹é•¿åº¦ã€æ—¶é—´è·¨åº¦ã€é€Ÿåº¦ç»Ÿè®¡ã€AVPç»Ÿè®¡
3. **å˜åŒ–ç‚¹æ£€æµ‹**ï¼šAVPçŠ¶æ€å˜åŒ–ã€é€Ÿåº¦çªå˜æ£€æµ‹
4. **æ•°æ®åº“ç®¡ç†**ï¼šè‡ªåŠ¨åˆ›å»ºè½¨è¿¹è¡¨å’Œå˜åŒ–ç‚¹è¡¨
5. **CLIæ¥å£**ï¼šå®Œæ•´çš„å‘½ä»¤è¡Œå‚æ•°æ”¯æŒ

### ä½¿ç”¨ç¤ºä¾‹
```bash
# åŸºç¡€è½¨è¿¹ç”Ÿæˆ
python -m spdatalab.dataset.trajectory --input test_trajectory_sample.txt --table test_trajectories

# åŒ…å«å˜åŒ–ç‚¹æ£€æµ‹
python -m spdatalab.dataset.trajectory \
    --input test_trajectory_sample.txt \
    --table test_trajectories \
    --detect-avp \
    --detect-speed \
    --speed-threshold 2.5 \
    --verbose

# æ‰¹é‡å¤„ç†ï¼ˆè°ƒæ•´æ‰¹æ¬¡å¤§å°ï¼‰
python -m spdatalab.dataset.trajectory \
    --input large_scene_list.txt \
    --table large_trajectories \
    --batch-size 50 \
    --detect-avp \
    --detect-speed
```

### æ•°æ®è¡¨ç»“æ„
**è½¨è¿¹è¡¨ (trajectories_[table_name])**:
- id, scene_id, point_count, start_time, end_time, duration
- avg_speed, max_speed, min_speed, std_speed
- avp_point_count, avp_ratio
- geometry (LineString), created_at

**å˜åŒ–ç‚¹è¡¨ (trajectories_[table_name]_events)**:
- id, scene_id, timestamp, event_type
- from_value, to_value, speed_value, speed_mean, z_score
- description, geometry (Point), created_at

### è¿›å±•æ›´æ–°
*åœ¨è¿™é‡Œè®°å½•å¼€å‘è¿›å±•å’Œé‡è¦å†³ç­–*

---

**å¼€å‘åŸåˆ™**: 
- ä¿æŒåŠŸèƒ½ç‹¬ç«‹ï¼Œä¸å½±å“bboxæ¨¡å—
- ä¼˜å…ˆæ ¸å¿ƒåŠŸèƒ½ï¼Œé€æ­¥å¢å¼º
- é‡è§†æ•°æ®è´¨é‡å’Œæ€§èƒ½
- ä¿æŒä»£ç ç®€æ´å¯ç»´æŠ¤ 