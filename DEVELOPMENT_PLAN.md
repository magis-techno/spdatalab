# Clips BBox 分表存储开发计划

## 项目背景

**核心挑战**：处理约500万条bbox数据，数据量庞大需要优化存储和查询性能

**关键信息**：
- 约130个子数据集，数量从1k到150k不等
- 需要通过QGIS进行可视化浏览
- 要求支持跨子数据集查询
- 子数据集名称需要规范化处理

## 核心需求总结

### 1. 数据存储优化
- 按子数据集分表存储，避免单表数据过大
- 支持并行处理不同子数据集
- 保持查询性能和数据完整性

### 2. 子数据集名称规范化
- 去除 `GOD_E2E_` 前缀
- 截断 `_sub_ddi_` 及之后内容
- 截断类似 `_277736e2e_` 的哈希模式（277打头，e2e结尾）及之后内容
- 保留时间戳格式 `_YYYY_MM_DD_HH_MM_SS`
- 生成符合PostgreSQL规范的表名

### 3. 统一查询接口
- 创建统一视图支持跨数据集查询
- 动态管理视图，避免硬编码
- 为QGIS提供友好的查询界面

### 4. 向下兼容
- 保持原有单表模式功能
- 提供平滑的迁移路径
- 不影响现有的使用方式

## 开发任务清单

### Phase 1: 核心功能开发 🔄

#### 1.1 子数据集名称规范化 ✅
- [x] 实现 `normalize_subdataset_name()` 函数
- [x] 实现 `get_table_name_for_subdataset()` 函数
- [x] 处理特殊字符和长度限制
- [x] 添加规范化日志输出
- [x] 新增处理 `_277...e2e_` 哈希模式截断

#### 1.2 分表存储架构 ✅
- [x] 实现 `create_table_for_subdataset()` 函数
- [x] 批量创建分表功能
- [x] 表结构和索引标准化
- [x] 错误处理和重试机制

#### 1.3 数据分组和路由 ✅
- [x] 实现 `group_scenes_by_subdataset()` 函数
- [x] 集成 DatasetManager 获取子数据集信息
- [x] 数据路由到对应分表
- [ ] 进度跟踪分离（每个子数据集独立）

#### 1.4 统一视图管理 ⏳
- [ ] 实现 `create_unified_view()` 动态视图创建
- [ ] 实现 `maintain_unified_view()` 视图维护
- [ ] 自动发现分表功能
- [ ] 视图增量更新机制

### Phase 2: 流程集成 ⏸️

#### 2.1 主流程改造
- [ ] 修改 `run()` 函数支持分表模式
- [ ] 实现 `run_with_partitioning()` 新入口
- [ ] 并行处理支持（可选）
- [ ] 错误恢复和断点续传

#### 2.2 命令行接口扩展
- [ ] 新增 `--use-partitioning` 参数
- [ ] 新增 `--create-unified-view` 参数
- [ ] 新增 `--maintain-view-only` 参数
- [ ] 新增 `--list-tables` 参数

#### 2.3 工具函数完善
- [ ] 实现 `list_bbox_tables()` 表管理
- [ ] 实现表统计和监控功能
- [ ] 数据迁移工具（单表→分表）
- [ ] 性能分析工具

### Phase 3: 测试和文档 ⏸️

#### 3.1 功能测试
- [ ] 子数据集名称规范化单元测试
- [ ] 小规模数据分表功能验证
- [ ] 统一视图查询性能测试
- [ ] QGIS连接和可视化测试

#### 3.2 性能测试
- [ ] 大数据量处理性能测试
- [ ] 并发查询性能测试
- [ ] 内存使用优化验证
- [ ] 磁盘空间使用分析

#### 3.3 文档完善
- [ ] 更新命令行帮助文档
- [ ] 分表模式使用指南
- [ ] QGIS集成文档
- [ ] 故障排除指南

## 开发计划和验收点

### 🎯 Sprint 1 (当前) - 分表存储架构
**目标**: 完成基础的分表创建和数据分组功能

**开发任务**:
1. 实现 `create_table_for_subdataset()` 函数
2. 实现 `group_scenes_by_subdataset()` 函数  
3. 基础的分表数据插入功能

**验收标准**:
- [ ] 能够根据子数据集名称创建规范的分表
- [ ] 能够从dataset文件中正确分组scene_ids
- [ ] 小规模测试数据（<1000条）能成功插入分表
- [ ] 分表结构和索引与主表一致

**预估时间**: 2-3天

### 🎯 Sprint 2 - 统一视图和流程集成
**目标**: 完成统一视图创建和主流程改造

**开发任务**:
1. 实现动态统一视图创建
2. 修改主处理流程支持分表模式
3. 命令行参数扩展

**验收标准**:
- [ ] 统一视图能正确聚合所有分表数据
- [ ] `--use-partitioning` 模式能正常工作
- [ ] 中等规模测试数据（1-5万条）处理成功
- [ ] 跨数据集查询功能正常

**预估时间**: 3-4天

### 🎯 Sprint 3 - 生产环境验证
**目标**: 大规模数据测试和QGIS集成验证

**开发任务**:
1. 大规模数据处理测试
2. QGIS连接和可视化验证
3. 性能优化和错误处理

**验收标准**:
- [ ] 能处理完整的500万条数据
- [ ] QGIS能正常连接和浏览数据
- [ ] 查询性能满足使用需求
- [ ] 错误恢复机制工作正常

**预估时间**: 3-5天

## 验证检查点

### ✅ 检查点 1: 环境清理
- [x] `sql/cleanup.sql` 能彻底清理所有相关数据
- [x] `sql/cleanup_partitioned.sql` 能选择性清理分表

### ⏳ 检查点 2: 基础功能 (Sprint 1 结束)
- [x] 名称规范化函数通过单元测试
- [x] 分表创建功能正常工作
- [x] 数据分组功能正确
- [ ] 小规模数据插入成功 (待测试验证)

### ⏸️ 检查点 3: 集成功能 (Sprint 2 结束)
- [ ] 统一视图查询正常
- [ ] 分表模式端到端流程通过
- [ ] 命令行参数功能完整
- [ ] 中规模数据处理成功

### ⏸️ 检查点 4: 生产就绪 (Sprint 3 结束)
- [ ] 大规模数据处理稳定
- [ ] QGIS集成验证通过
- [ ] 性能指标达到要求
- [ ] 文档和使用指南完整

## 风险和注意事项

### 技术风险
- **表名长度限制**: PostgreSQL 63字符限制，需要合理截断
- **内存使用**: 大数据量处理时的内存管理
- **并发冲突**: 多进程处理时的资源竞争

### 业务风险  
- **数据一致性**: 分表后跨表查询的一致性保证
- **性能影响**: QGIS查询大量分表的性能影响
- **维护复杂度**: 130+张表的管理复杂度

### 缓解措施
- 充分的单元测试和集成测试
- 小规模→中规模→大规模的渐进式验证
- 保持原有单表模式作为备选方案
- 详细的错误日志和监控

## 当前状态

**最新更新**: 2024-12-19

**当前进度**: Phase 1.1 完成，开始 Phase 1.2

**下一步行动**: 
1. 实现 `create_table_for_subdataset()` 函数
2. 实现 `group_scenes_by_subdataset()` 函数
3. 进行 Sprint 1 的验收测试

---

## 更新日志

### 2024-12-19
- ✅ 完成子数据集名称规范化功能
- ✅ 完成清理脚本增强
- 📋 创建开发计划文档
- ✅ 完成分表存储架构开发
- ✅ 完成数据分组和路由功能
- 📋 创建Sprint 1功能测试脚本
- ✅ 更新名称规范化规则（新增 `_277...e2e_` 模式处理）
- 📋 更新测试用例和开发文档
- ✅ 修复PostGIS表创建的事务管理问题
- ✅ 实现保守的表名长度截断策略（限制50字符）
- ✅ 创建详细的调试脚本
- ✅ 加强连续下划线检查和清理
- ✅ 添加表名合法性验证函数
- ⏳ 准备进入Sprint 1验收测试 